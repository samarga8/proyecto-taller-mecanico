<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Detalle de Reparación</title>

    <link th:href="@{/css/styles.css}" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
</head>
<body>

<div th:insert="~{fragments/header :: cabecera}"></div>

<div class="container mt-5">

    <h1 class="mb-4">Detalle de Reparación</h1>

    <!-- Añadir pieza utilizada -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">Añadir Pieza Utilizada</div>
        <div class="card-body">
            <form th:action="@{/inventario/piezas/agregar}" method="post" class="row g-3">
                <input type="hidden" th:name="reparacion.id" th:value="${reparacion.id}"/>

                <div class="col-md-6">
                    <label for="inventario" class="form-label">Pieza del Inventario</label>
                    <select class="form-select" name="inventario.id" id="inventario" required>
                        <option value="">-- Seleccione una pieza --</option>
                        <option th:each="pieza : ${listaPiezas}"
                                th:value="${pieza.id}"
                                th:text="${pieza.nombre}">
                        </option>
                    </select>
                    <input type="hidden" name="nombre" id="nombreSeleccionado" />
                </div>

                <div class="col-md-4">
                    <label for="cantidadUsada" class="form-label">Cantidad</label>
                    <input type="number" class="form-control" id="cantidadUsada" name="cantidadUsada" min="1" required>
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">Añadir</button>
                </div>
            </form>

        </div>
    </div>


    <!-- Lista de piezas utilizadas -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">Piezas Utilizadas</div>
        <ul class="list-group list-group-flush" th:if="${reparacion.piezasUtilizadas != null}">
            <li class="list-group-item" th:each="pieza : ${reparacion.piezasUtilizadas}"
                th:text="${pieza.nombre} + ' x' + ${pieza.cantidadUsada}">
                Ejemplo: Filtro de aceite x1
            </li>
        </ul>
        <div class="card-body" th:if="${#lists.isEmpty(reparacion.piezasUtilizadas)}">
            <p class="text-muted">No se han añadido piezas aún.</p>
        </div>
    </div>

    <!-- Diagnóstico -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">Diagnóstico del Mecánico</div>
        <div class="card-body">
            <textarea id="form-reparacion" class="form-control" rows="4" th:field="${reparacion.descripcion}"></textarea>
        </div>
    </div>


    <div class="card mb-4">
        <div class="card-header bg-warning">Tiempo de reparación</div>
        <div class="card-body">
                <input type="hidden" th:name="reparacionId" th:value="${reparacion.id}"/>

                <div class="d-flex justify-content-between align-items-center gap-4 flex-wrap">
                    <div>
                        <label class="form-label mb-0">Fecha de inicio:
                            <span th:text="${#temporals.format(reparacion.fechaInicio, 'dd/MM/yyyy HH:mm')}"></span>
                        </label>
                    </div>
                    <div>
                        <label class="form-label mb-0">Fecha actual:
                            <span th:text="${#temporals.format(fechaActual, 'dd/MM/yyyy HH:mm')}"></span>
                        </label>
                    </div>
                    <div>
                        <label class="form-label mb-0">Tiempo transcurrido:
                            <span th:text="${tiempo}"></span>
                        </label>
                    </div>
                </div>
        </div>
    </div>
    <!-- Estado actual de la reparación -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">Estado Actual</div>
        <div class="card-body">
            <p class="fs-5 mb-0">
                <strong th:text="${reparacion.estado}"></strong>
            </p>
        </div>
    </div>


    <div th:if="${!#strings.equals(reparacion.estado, 'FINALIZADO')}" class="card mb-5">
        <div class="card-body text-center">
            <form th:action="@{/reparaciones/finalizar}" method="post">
                <input type="hidden" th:name="reparacionId" th:value="${reparacion.id}" />
                <button type="submit" class="btn btn-danger btn-lg"
                        onclick="return confirm('¿Estás seguro de que deseas finalizar esta reparación?')">
                    Finalizar Reparación
                </button>
            </form>
        </div>
    </div>
    <p>Estado actual: <span th:text="${reparacion.estado}"></span></p>

    <div th:if="${#strings.equals(reparacion.estado, 'FINALIZADO')}" class="text-center mt-3">
        <a th:href="@{/facturas/pagar/{id}(id=${reparacion.factura.id})}" class="btn btn-success btn-lg">
            Pagar Factura
        </a>
    </div>

    <div class="text-center">
        <a th:href="@{/reparaciones/lista}" class="btn btn-outline-secondary">Volver a la lista</a>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
        crossorigin="anonymous"></script>
</body>
</html>
